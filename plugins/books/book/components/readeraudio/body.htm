{% if redirectIfJSIsOff %}
<noscript>
    <meta http-equiv="refresh" content="0;url=https://bookstime.ru">
</noscript>
{% endif %}
<input type="hidden" name="paginator_id" value="{{reader.paginator.id}}"/>
<div class="reader__body">

    {% if reader.chapter.audio %}
        <div class="personal-area__wrap _indent-large ui-input">
            <div class="personal-area__wrap _indent-medium">
                {% partial 'audioplayer/default' audiofile = reader.chapter.audio %}
            </div>
        </div>
    {% endif %}

</div>
{% partial '@pagination' %}

{% if reader.chapter.audio %}
{% set progressSaveTimeout = constant('Books\\Book\\Models\\AudioReadProgress::SAVE_USER_AUDIO_READ_PROGRESS_TIMEOUT_SECONDS') %}
{% set progressSaveStepSeconds = constant('Books\\Book\\Models\\AudioReadProgress::SAVE_USER_AUDIO_READ_PROGRESS_STEP_SECONDS') %}
<script>
    const options = {
        onPlayCallback: function (player) {
            trackProgress(player);
        },
        onPauseCallback: function (player) {
            stopTrackingProgress(player);
        },
        onEndCallback: function (player) {
            nextChapter(player);
        }
    };
    initAudioPlayer(options);

    //const players = window.audioPlayer;
    //const audioBookPlayer = window.audioPlayer[Object.keys(players)[0]];

    const progressSaveTimeout = {{ progressSaveTimeout * 1000 }};
    const progressSaveStepSeconds = {{ progressSaveStepSeconds }};
    var progressT;

    function trackProgress(player) {
        console.log('track once for play button press');
        progressT = setInterval(function() {
            updateProgress(player);
        }, progressSaveTimeout)
    }

    function updateProgress(player) {
        let progress = parseInt(player.currentSeek());
        console.log(progress);

        if (progress >= progressSaveStepSeconds) {
            oc.ajax('onSaveProgress', {
                data: {
                    book: "{{ book.id }}",
                    chapter: "{{ reader.chapter.id }}",
                    progress: progress
                },
                progressBar: false,
                error: (e) => console.log(e), // function (e) {console.log(e);}
            })
        }

        console.log('send progress: ' + progress + ' sec');
    }

    function stopTrackingProgress(player) {
        console.log('stopSendingProgress');
        clearTimeout(progressT);
    }

    function nextChapter(player) {
        console.log('load next chapter');
    }

</script>
{% endif %}